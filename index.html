<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Pro Steven - Plataforma Fitness IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- NUEVA PALETA DE COLORES Y ESTILOS LLAMATIVOS --- */
        :root {
            --primary-blue: #007BFF;
            --vibrant-purple: #8A2BE2;
            --electric-cyan: #00FFFF;
            --dark-bg: #0a0a10;
            --card-bg: rgba(20, 20, 30, 0.7);
            --card-border: rgba(138, 43, 226, 0.3);
            --text-light: #e5e7eb;
            --text-dark: #9ca3af;
            --premium-gold: #FFD700;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 1% 1%, var(--primary-blue), transparent 25%), radial-gradient(circle at 99% 99%, var(--vibrant-purple), transparent 25%);
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-light);
            transition: background-image 0.4s ease-in-out;
        }

        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 1.5rem;
            transition: all 0.3s;
        }
        .card:hover {
            border-color: var(--electric-cyan);
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .btn-primary {
            background-image: linear-gradient(to right, var(--primary-blue), var(--vibrant-purple));
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.5);
        }
        .btn-primary:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
            transform: none;
        }

        .form-input, .form-textarea {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            width: 100%;
            transition: all 0.2s;
        }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-dark); }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.5);
            border-color: var(--electric-cyan);
        }

        .nav-link.active {
            background-image: linear-gradient(to right, var(--primary-blue), var(--vibrant-purple));
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .nav-link-mobile.active {
            color: var(--electric-cyan);
            border-top: 3px solid var(--electric-cyan);
        }
        .nav-link-mobile.active > span { color: var(--electric-cyan); }

        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        
        .loader {
            border: 4px solid #333;
            border-top: 4px solid var(--electric-cyan);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .premium-badge {
            background: linear-gradient(45deg, #FFD700, #F0B400);
            color: #333;
            padding: 2px 8px;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .locked-feature {
            position: relative;
            opacity: 0.5;
            pointer-events: none;
        }
        .locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            color: var(--premium-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 1rem;
            z-index: 10;
            pointer-events: all;
            cursor: pointer;
        }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .chart-container { position: relative; margin: auto; height: 280px; width: 280px; }
        @media (min-width: 640px) { .chart-container { height: 320px; width: 320px; } }
        .workout-day-btn.active { background-image: linear-gradient(to right, var(--primary-blue), var(--vibrant-purple)); color: white; }
        .workout-day-btn:not(.active) { background-color: #262626; color: var(--text-dark); }
    </style>
</head>
<body class="antialiased">

    <!-- ===== CONTENEDOR PRINCIPAL Y MODALES ===== -->
    <div id="app-loader" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>
    
    <!-- MODAL DE AUTENTICACIÓN -->
    <div id="auth-container" class="hidden min-h-screen w-full items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="card text-center">
                <div class="flex items-center justify-center gap-3 mb-6">
                    <svg class="h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.75 6.75C8.16421 6.75 9.33333 7.91921 9.33333 9.33333C9.33333 10.7475 8.16421 11.9167 6.75 11.9167C5.33579 11.9167 4.16667 10.7475 4.16667 9.33333C4.16667 7.91921 5.33579 6.75 6.75 6.75ZM6.75 8.25C6.19772 8.25 5.75 8.70181 5.75 9.24542C5.75 9.32458 5.75 9.49167 5.75 9.49167C5.83579 10.0279 6.24188 10.4167 6.75 10.4167C7.25812 10.4167 7.66421 10.0279 7.75 9.49167C7.75 9.49167 7.75 9.32458 7.75 9.24542C7.75 8.70181 7.30228 8.25 6.75 8.25ZM20.75 11.5833C20.75 12.3923 20.0923 13.0833 19.25 13.0833C18.4077 13.0833 17.75 12.3923 17.75 11.5833C17.75 10.7744 18.4077 10.0833 19.25 10.0833C20.0923 10.0833 20.75 10.7744 20.75 11.5833ZM15.4167 4.66667C15.4167 3.85771 14.759 3.16667 13.9167 3.16667C13.0744 3.16667 12.4167 3.85771 12.4167 4.66667C12.4167 5.47562 13.0744 6.16667 13.9167 6.16667C14.759 6.16667 15.4167 5.47562 15.4167 4.66667ZM18.5 7.66667C16.9739 7.66667 15.6946 8.74608 15.4674 10.2083H15.25C14.2835 10.2083 13.4167 9.34151 13.4167 8.375V8C13.4167 7.15771 12.759 6.5 11.9167 6.5C11.0744 6.5 10.4167 7.15771 10.4167 8V12.75C10.4167 14.8211 12.0956 16.5 14.1667 16.5H14.5C14.7761 16.5 15 16.2761 15 16V13.25C15 12.6977 15.4477 12.25 16 12.25H16.25C16.8023 12.25 17.25 12.6977 17.25 13.25V16C17.25 16.2761 17.4739 16.5 17.75 16.5H18.0833C19.9603 16.5 21.5 14.9943 21.5 13.125V11.5833C21.5 9.41223 19.9943 7.66667 18.5 7.66667ZM11.1667 20.8333L10 17.25H8.25L7.08333 20.8333H11.1667Z"/></svg>
                    <h1 class="text-3xl font-black tracking-wider text-white">STEVEN PRO</h1>
                </div>
                <!-- Formulario de Login -->
                <form id="login-form" class="space-y-4">
                    <h2 class="text-xl font-bold text-white">Iniciar Sesión</h2>
                    <input type="email" id="login-email" class="form-input" placeholder="Correo electrónico" required>
                    <input type="password" id="login-password" class="form-input" placeholder="Contraseña" required>
                    <button type="submit" class="btn-primary w-full">Entrar</button>
                    <p class="text-sm text-gray-400">¿No tienes cuenta? <a href="#" id="show-register" class="font-bold text-electric-cyan hover:underline">Regístrate</a></p>
                </form>
                <!-- Formulario de Registro -->
                <form id="register-form" class="hidden space-y-4">
                    <h2 class="text-xl font-bold text-white">Crear Cuenta</h2>
                    <input type="email" id="register-email" class="form-input" placeholder="Correo electrónico" required>
                    <input type="password" id="register-password" class="form-input" placeholder="Contraseña (mín. 6 caracteres)" required>
                    <button type="submit" class="btn-primary w-full">Registrarse</button>
                    <p class="text-sm text-gray-400">¿Ya tienes cuenta? <a href="#" id="show-login" class="font-bold text-electric-cyan hover:underline">Inicia Sesión</a></p>
                </form>
                <p id="auth-error" class="text-red-400 mt-4 h-4"></p>
            </div>
        </div>
    </div>

    <!-- ===== APLICACIÓN PRINCIPAL (OCULTA INICIALMENTE) ===== -->
    <div id="main-app" class="hidden min-h-screen pb-16 md:pb-0">
        <!-- HEADER -->
        <header class="bg-black/50 backdrop-blur-md shadow-lg sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <svg class="h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.75 6.75C8.16421 6.75 9.33333 7.91921 9.33333 9.33333C9.33333 10.7475 8.16421 11.9167 6.75 11.9167C5.33579 11.9167 4.16667 10.7475 4.16667 9.33333C4.16667 7.91921 5.33579 6.75 6.75 6.75ZM6.75 8.25C6.19772 8.25 5.75 8.70181 5.75 9.24542C5.75 9.32458 5.75 9.49167 5.75 9.49167C5.83579 10.0279 6.24188 10.4167 6.75 10.4167C7.25812 10.4167 7.66421 10.0279 7.75 9.49167C7.75 9.49167 7.75 9.32458 7.75 9.24542C7.75 8.70181 7.30228 8.25 6.75 8.25ZM20.75 11.5833C20.75 12.3923 20.0923 13.0833 19.25 13.0833C18.4077 13.0833 17.75 12.3923 17.75 11.5833C17.75 10.7744 18.4077 10.0833 19.25 10.0833C20.0923 10.0833 20.75 10.7744 20.75 11.5833ZM15.4167 4.66667C15.4167 3.85771 14.759 3.16667 13.9167 3.16667C13.0744 3.16667 12.4167 3.85771 12.4167 4.66667C12.4167 5.47562 13.0744 6.16667 13.9167 6.16667C14.759 6.16667 15.4167 5.47562 15.4167 4.66667ZM18.5 7.66667C16.9739 7.66667 15.6946 8.74608 15.4674 10.2083H15.25C14.2835 10.2083 13.4167 9.34151 13.4167 8.375V8C13.4167 7.15771 12.759 6.5 11.9167 6.5C11.0744 6.5 10.4167 7.15771 10.4167 8V12.75C10.4167 14.8211 12.0956 16.5 14.1667 16.5H14.5C14.7761 16.5 15 16.2761 15 16V13.25C15 12.6977 15.4477 12.25 16 12.25H16.25C16.8023 12.25 17.25 12.6977 17.25 13.25V16C17.25 16.2761 17.4739 16.5 17.75 16.5H18.0833C19.9603 16.5 21.5 14.9943 21.5 13.125V11.5833C21.5 9.41223 19.9943 7.66667 18.5 7.66667ZM11.1667 20.8333L10 17.25H8.25L7.08333 20.8333H11.1667Z"/></svg>
                        <h1 class="text-2xl font-black tracking-wider text-white">STEVEN</h1>
                    </div>
                    <nav class="hidden md:flex space-x-2" id="main-nav">
                         <a href="#" data-tab="resumen" class="nav-link active px-3 py-2 rounded-md text-sm font-medium">Resumen</a>
                         <a href="#" data-tab="fit-ai" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Fit-AI</a>
                         <a href="#" data-tab="nutricion" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Nutrición</a>
                         <a href="#" data-tab="entrenamiento" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Entrenamiento</a>
                         <a href="#" data-tab="progreso" class="nav-link px-3 py-2 rounded-md text-sm font-medium">Progreso</a>
                         <a href="#" data-tab="premium" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-premium-gold">⭐ Premium</a>
                    </nav>
                    <div id="user-info" class="flex items-center gap-4">
                        <span id="user-email" class="text-sm text-gray-300 hidden md:block"></span>
                        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Salir</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <!-- SECCIONES DE CONTENIDO (Resumen, Fit-AI, etc.) -->
                <section id="resumen" class="content-section active">
                    <!-- Contenido de Resumen -->
                </section>
                <section id="fit-ai" class="content-section">
                    <!-- Contenido de Fit-AI -->
                </section>
                <section id="nutricion" class="content-section">
                    <!-- Contenido de Nutrición -->
                </section>
                <section id="entrenamiento" class="content-section">
                    <!-- Contenido de Entrenamiento -->
                </section>
                <section id="progreso" class="content-section">
                    <!-- Contenido de Progreso -->
                </section>
                
                <!-- ===== NUEVA SECCIÓN PREMIUM ===== -->
                <section id="premium" class="content-section">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl font-bold tracking-tight sm:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-premium-gold">Desbloquea tu Máximo Potencial</h2>
                        <p class="mt-4 text-lg text-gray-400">Accede a herramientas exclusivas con el Plan Premium.</p>
                    </div>

                    <div id="premium-content" class="hidden">
                        <div class="card text-center max-w-2xl mx-auto">
                            <h3 class="text-2xl font-bold text-premium-gold">¡Ya eres Premium!</h3>
                            <p class="text-gray-300 mt-2">Gracias por ser parte del club. Tu suscripción está activa.</p>
                            <p id="premium-expiry" class="mt-2 text-sm text-gray-500"></p>
                            <hr class="my-6 border-gray-700">
                            <h4 class="text-xl font-bold text-white">Administración</h4>
                            <div class="mt-4 flex flex-col sm:flex-row gap-4 justify-center">
                                <button id="show-online-users-btn" class="btn-primary flex-1">Ver Usuarios Conectados</button>
                                <button id="show-owner-code-btn" class="btn-primary flex-1 bg-gradient-to-r from-green-400 to-blue-500">Activar Código Dueño</button>
                            </div>
                        </div>
                    </div>

                    <div id="non-premium-content">
                        <div class="card max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold text-white">Obtén el Plan Pro Steven</h3>
                            <p class="text-premium-gold text-4xl font-black my-4">$50.000 COP</p>
                            <p class="text-gray-400 mb-6">por 2 meses de acceso total.</p>
                            <ul class="text-left space-y-3 mb-8">
                                <li class="flex items-center gap-3"><span class="text-green-400">✔️</span><span>Análisis de progreso con IA Avanzado.</span></li>
                                <li class="flex items-center gap-3"><span class="text-green-400">✔️</span><span>Generador de rutinas y dietas ilimitado.</span></li>
                                <li class="flex items-center gap-3"><span class="text-green-400">✔️</span><span>Soporte prioritario.</span></li>
                            </ul>
                            <button id="pay-premium-btn" class="btn-primary w-full text-lg">¡Obtener Premium Ahora!</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- NAVEGACIÓN MÓVIL -->
        <div class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-md shadow-[0_-2px_10px_rgba(0,0,0,0.5)] md:hidden h-16">
            <nav class="flex justify-around items-center h-full" id="mobile-nav">
                 <a href="#" data-tab="resumen" class="nav-link-mobile active flex flex-col items-center text-xs p-1 text-gray-400">📊<span class="mt-1">Resumen</span></a>
                 <a href="#" data-tab="fit-ai" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">🤖<span class="mt-1">Fit-AI</span></a>
                 <a href="#" data-tab="nutricion" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">🍎<span class="mt-1">Nutrición</span></a>
                 <a href="#" data-tab="entrenamiento" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">🏋️<span class="mt-1">Entreno</span></a>
                 <a href="#" data-tab="progreso" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">📈<span class="mt-1">Progreso</span></a>
                 <a href="#" data-tab="premium" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-premium-gold">⭐<span class="mt-1">Premium</span></a>
            </nav>
        </div>
    </div>
    
    <!-- MODALES DE LA APLICACIÓN -->
    <div id="alert-modal" class="modal-overlay"><div class="card max-w-sm w-full text-center"><p id="alert-modal-message" class="text-white mb-6"></p><div id="alert-modal-buttons" class="flex justify-center gap-4"></div></div></div>
    <div id="ai-modal" class="modal-overlay"><div class="card max-w-2xl w-full"><div class="flex justify-between items-center pb-3 border-b border-gray-700"><h3 id="ai-modal-title" class="text-xl font-bold text-white text-left"></h3><button id="ai-modal-close" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div><div class="p-4 overflow-y-auto max-h-[70vh] text-left"><div id="ai-modal-loader" class="hidden justify-center items-center p-12"><div class="loader"></div></div><div id="ai-modal-content"></div></div></div></div>
    <div id="owner-code-modal" class="modal-overlay"><div class="card max-w-sm w-full text-center"><h3 class="text-xl font-bold text-white mb-4">Código de Dueño</h3><p class="text-gray-400 mb-4">Introduce tu código secreto para activar el plan premium.</p><form id="owner-code-form"><input type="password" id="owner-code-input" class="form-input text-center" placeholder="Código Secreto"><button type="submit" class="btn-primary w-full mt-4">Activar</button></form><button id="close-owner-modal-btn" class="mt-2 text-gray-400 hover:text-white">Cerrar</button></div></div>
    <div id="online-users-modal" class="modal-overlay"><div class="card max-w-md w-full"><h3 class="text-xl font-bold text-white mb-4 text-center">Usuarios en Tiempo Real</h3><div id="online-users-list" class="space-y-3 max-h-60 overflow-y-auto"></div><button id="close-online-users-btn" class="btn-primary w-full mt-4">Cerrar</button></div></div>
    
    <!-- Scripts de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase (se completa automáticamente en el entorno)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Variables globales de la app
        let currentUser = null;
        let userData = null;
        let unsubscribePresence; // Para detener el listener de presencia

        // --- LÓGICA DE AUTENTICACIÓN Y SESIÓN ---
        const appLoader = document.getElementById('app-loader');
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');

        // Cambiar entre formularios de login y registro
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });

        // Manejar registro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Crear documento de usuario en Firestore
                const userDocRef = doc(db, "users", userCredential.user.uid);
                await setDoc(userDocRef, {
                    email: userCredential.user.email,
                    uid: userCredential.user.uid,
                    isPremium: false,
                    premiumExpires: null,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                authError.textContent = "Error al registrar: " + error.message;
            }
        });

        // Manejar inicio de sesión
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await setPersistence(auth, browserLocalPersistence); // Mantener sesión iniciada
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = "Error al iniciar sesión: " + error.message;
            }
        });

        // Manejar cierre de sesión
        document.getElementById('logout-btn').addEventListener('click', () => {
             if (currentUser) {
                const presenceRef = doc(db, "presence", currentUser.uid);
                deleteDoc(presenceRef); // Eliminar estado de presencia al salir
            }
            signOut(auth);
        });

        // Listener de estado de autenticación (el corazón de la app)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Obtener datos del usuario de Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    userData = userDocSnap.data();
                    // Iniciar la aplicación principal
                    initializeAppUI();
                    // Configurar sistema de presencia
                    setupPresenceSystem();
                } else {
                    // Caso raro: usuario autenticado pero sin documento
                    console.error("No se encontró el documento del usuario.");
                    signOut(auth);
                }
            } else {
                currentUser = null;
                userData = null;
                // Detener listener de presencia si existe
                if (unsubscribePresence) unsubscribePresence();
                // Mostrar UI de autenticación
                authContainer.style.display = 'flex';
                mainAppContainer.classList.add('hidden');
            }
            appLoader.style.display = 'none';
        });
        
        // --- SISTEMA DE PRESENCIA EN TIEMPO REAL ---
        async function setupPresenceSystem() {
            const uid = currentUser.uid;
            const presenceRef = doc(db, "presence", uid);

            // Firestore conoce cuando un cliente se desconecta y puede ejecutar acciones
            // Usamos onSnapshot para actualizar en tiempo real
             onSnapshot(doc(db, ".info/connected"), (snap) => {
                 if (snap.val() === true) {
                    // Estamos conectados
                 }
             });

            // Actualizar el estado a 'online'
            await setDoc(presenceRef, {
                uid: uid,
                email: currentUser.email,
                status: 'online',
                last_seen: serverTimestamp()
            });
            
            // Actualizar 'last_seen' periódicamente
            setInterval(() => {
                if (currentUser) {
                    updateDoc(presenceRef, { last_seen: serverTimestamp() });
                }
            }, 60000); // Cada minuto

            // Detectar cuando la pestaña se cierra
            window.addEventListener('beforeunload', () => {
                deleteDoc(presenceRef);
            });
        }

        // --- LÓGICA DE LA INTERFAZ DE USUARIO PRINCIPAL ---
        function initializeAppUI() {
            authContainer.style.display = 'none';
            mainAppContainer.classList.remove('hidden');
            document.getElementById('user-email').textContent = currentUser.email;
            
            // Cargar el contenido de las secciones desde un archivo externo o definirlas aquí
            // Por simplicidad, las dejaremos vacías pero aquí es donde se cargaría el HTML de cada sección
            loadSectionsContent();
            
            // Actualizar la UI basada en el estado premium
            updatePremiumUI();

            // Aquí iría el resto de la inicialización de la app (gráficos, eventos, etc.)
            // Por ejemplo: renderMacroChart();
        }

        function loadSectionsContent() {
            // Aquí cargarías el HTML de cada sección para mantener el código limpio
            // Ejemplo:
            document.getElementById('resumen').innerHTML = `
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold tracking-tight sm:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-white to-electric-cyan">Tu Panel de Control</h2>
                    <p class="mt-4 text-lg text-gray-400">Resumen de tus objetivos y estado actual.</p>
                </div>
                <!-- El resto del contenido de resumen aquí -->
            `;
            // Repetir para las otras secciones...
        }

        // --- LÓGICA PREMIUM ---
        const premiumContent = document.getElementById('premium-content');
        const nonPremiumContent = document.getElementById('non-premium-content');
        const premiumExpiryEl = document.getElementById('premium-expiry');

        function updatePremiumUI() {
            // Comprobar si la suscripción ha expirado
            if (userData.isPremium && userData.premiumExpires && userData.premiumExpires.toDate() < new Date()) {
                userData.isPremium = false;
                updateDoc(doc(db, "users", currentUser.uid), { isPremium: false });
            }

            if (userData.isPremium) {
                premiumContent.classList.remove('hidden');
                nonPremiumContent.classList.add('hidden');
                const expiryDate = userData.premiumExpires.toDate().toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
                premiumExpiryEl.textContent = `Tu acceso expira el: ${expiryDate}`;
                // Desbloquear features
                document.querySelectorAll('.locked-feature').forEach(el => el.classList.remove('locked-feature'));
                document.querySelectorAll('.locked-overlay').forEach(el => el.remove());

            } else {
                premiumContent.classList.add('hidden');
                nonPremiumContent.classList.remove('hidden');
                // Bloquear features
                // Ejemplo: document.getElementById('analyze-progress-btn').closest('.card').classList.add('locked-feature');
            }
        }
        
        // Simulación de pago
        document.getElementById('pay-premium-btn').addEventListener('click', () => {
            showAlert('Redirigiendo a la pasarela de pago... (Simulación)', 'info');
            setTimeout(() => {
                upgradeToPremium();
            }, 2000);
        });

        async function upgradeToPremium() {
            const expiryDate = new Date();
            expiryDate.setMonth(expiryDate.getMonth() + 2); // Añadir 2 meses
            
            await updateDoc(doc(db, "users", currentUser.uid), {
                isPremium: true,
                premiumExpires: expiryDate
            });
            
            // Actualizar datos locales y UI
            userData.isPremium = true;
            userData.premiumExpires = { toDate: () => expiryDate }; // Simular objeto Timestamp de Firestore
            updatePremiumUI();
            showAlert('¡Felicidades! Tu plan Premium ha sido activado.', 'success');
        }
        
        // Modal de código de dueño
        const ownerCodeModal = document.getElementById('owner-code-modal');
        document.getElementById('show-owner-code-btn').addEventListener('click', () => ownerCodeModal.style.display = 'flex');
        document.getElementById('close-owner-modal-btn').addEventListener('click', () => ownerCodeModal.style.display = 'none');
        document.getElementById('owner-code-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('owner-code-input').value;
            // El código secreto
            if (code === 'STEVENPRO') {
                upgradeToPremium();
                ownerCodeModal.style.display = 'none';
            } else {
                showAlert('Código incorrecto.', 'error');
            }
        });

        // Modal de usuarios en línea
        const onlineUsersModal = document.getElementById('online-users-modal');
        const onlineUsersList = document.getElementById('online-users-list');
        document.getElementById('show-online-users-btn').addEventListener('click', () => {
            onlineUsersModal.style.display = 'flex';
            // Empezar a escuchar a los usuarios en línea
            const presenceCollection = collection(db, "presence");
            unsubscribePresence = onSnapshot(presenceCollection, (snapshot) => {
                let usersHTML = '';
                snapshot.docs.forEach(doc => {
                    const user = doc.data();
                    if (user.status === 'online') {
                        usersHTML += `
                            <div class="flex items-center justify-between bg-gray-800 p-2 rounded-lg">
                                <span class="text-gray-300">${user.email}</span>
                                <span class="flex items-center gap-2 text-green-400 text-sm">
                                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                    En línea
                                </span>
                            </div>
                        `;
                    }
                });
                onlineUsersList.innerHTML = usersHTML || '<p class="text-center text-gray-500">Nadie más está conectado.</p>';
            });
        });
        document.getElementById('close-online-users-btn').addEventListener('click', () => {
            onlineUsersModal.style.display = 'none';
            // Detener el listener para no consumir recursos innecesariamente
            if (unsubscribePresence) {
                unsubscribePresence();
            }
        });

        // --- FUNCIONES DE UTILIDAD (MODALES, ETC.) ---
        const alertModal = document.getElementById('alert-modal');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const alertModalButtons = document.getElementById('alert-modal-buttons');

        function showAlert(message, type = 'default') {
            let colorClass = 'btn-primary';
            if (type === 'error') colorClass = 'bg-red-600 hover:bg-red-700';
            if (type === 'success') colorClass = 'bg-green-600 hover:bg-green-700';

            alertModalMessage.textContent = message;
            alertModalButtons.innerHTML = `<button id="alert-ok-btn" class="${colorClass} text-white font-bold py-2 px-6 rounded-lg">OK</button>`;
            alertModal.style.display = 'flex';
            document.getElementById('alert-ok-btn').onclick = () => alertModal.style.display = 'none';
        }

        // --- LÓGICA DE NAVEGACIÓN ---
        const navLinks = document.querySelectorAll('#main-nav a, #mobile-nav a');
        const contentSections = document.querySelectorAll('.content-section');
        
        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const tabId = e.currentTarget.dataset.tab;
                contentSections.forEach(s => s.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                navLinks.forEach(l => l.classList.remove('active'));
                document.querySelectorAll(`.nav-link[data-tab="${tabId}"], .nav-link-mobile[data-tab="${tabId}"]`).forEach(activeLink => activeLink.classList.add('active'));
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
        
        // Cierre de modales AI
        document.getElementById('ai-modal-close').addEventListener('click', () => {
            document.getElementById('ai-modal').style.display = 'none';
        });

    </script>
</body>
</html>
