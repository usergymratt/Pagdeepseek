<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Pro Daniel Ramírez - Edición IA Mejorada</title>
    
    <meta name="theme-color" content="#1a1a2e"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Plan Pro">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/google/material-design-icons/master/png/action/fitness_center/materialicons/512dp/1x/baseline_fitness_center_white_512dp.png">
    
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #4f46e5; 
            --secondary-color: #ec4899;
            --accent-color: #38bdf8;
            --dark-bg: #0f172a; 
            --card-bg: rgba(22, 32, 53, 0.7);
            --text-light: #e2e8f0; 
            --text-dark: #94a3b8;
            --premium-gold: #f59e0b;
        }
        
        html { scroll-behavior: smooth; }
        body {  
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 1% 1%, var(--primary-color), rgba(255,255,255,0) 25%), radial-gradient(circle at 99% 99%, var(--secondary-color), rgba(255,255,255,0) 25%);
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-light);
        }

        .nav-link.active { background-color: var(--primary-color); color: white; }
        .nav-link:not(.active) { color: var(--text-dark); }
        .nav-link:not(.active):hover { background-color: #1e293b; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .chart-container { position: relative; margin: auto; height: 280px; width: 280px; }
        @media (min-width: 640px) { .chart-container { height: 320px; width: 320px; } }
        .workout-day-btn.active { background-color: var(--primary-color); color: white; }
        .workout-day-btn:not(.active) { background-color: #1e293b; color: var(--text-dark); border: 1px solid #334155; }
        .workout-day-btn:not(.active):hover { background-color: #334155; }
        .card {  
            background-color: var(--card-bg);  
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #334155;  
            border-radius: 0.75rem;  
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.2);  
            padding: 1.5rem;  
            transition: all 0.3s;  
        }
        .card:hover { border-color: var(--accent-color); transform: translateY(-5px); }
        .nav-link-mobile.active { border-top: 2px solid var(--primary-color); color: var(--primary-color); }
        .nav-link-mobile.active > span { color: var(--primary-color); font-weight: 600; }
        .form-input, .form-textarea, .form-select { background-color: #1e293b; border: 1px solid #475569; border-radius: 0.375rem; padding: 0.75rem 1rem; color: var(--text-light); width: 100%; }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-dark); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; box-shadow: 0 0 0 2px var(--primary-color); border-color: var(--primary-color); }
        .btn-primary { background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color)); color: white; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: all 0.3s; cursor: pointer; text-align: center; border: none; background-size: 200% auto; }
        .btn-primary:hover { background-position: right center; box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); }
        .btn-primary:disabled { background-image: none; background-color: #475569; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: #334155; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s; cursor: pointer; font-size: 0.875rem; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-danger { background-color: #b91c1c; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
        .btn-danger:hover { background-color: #991b1b; }
        .loader { border: 4px solid #334155; border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-container { position: relative; width: 90%; max-width: 500px; padding: 20px; background: var(--dark-bg); border-radius: 0.75rem; border: 1px solid #334155; text-align: center; }
        .premium-badge { background-image: linear-gradient(to right, #f59e0b, #f97316); color: white; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; }
        [data-premium-only] { position: relative; overflow: hidden; }
        [data-premium-only].locked::after { content: '⭐ Disponible en Premium'; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center; color: var(--premium-gold); font-weight: bold; cursor: pointer; z-index: 10; }
    </style>
</head>
<body class="antialiased">

    <!-- MODALS -->
    <div id="auth-modal" class="modal-overlay"><div class="modal-container"><button class="modal-close-btn absolute top-2 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button><div id="auth-modal-content"></div></div></div>
    <div id="admin-modal" class="modal-overlay"><div class="modal-container max-w-2xl"><button class="modal-close-btn absolute top-2 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button><h3 class="text-2xl font-bold text-center text-white mb-4">Panel de Administrador</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card"><h4 class="text-lg font-bold text-accent-color mb-3">Activar Premium</h4><form id="premium-code-form"><input type="text" id="premium-code-input" class="form-input" placeholder="Ingresa código de activación"><button type="submit" class="btn-primary w-full mt-3">Activar</button></form></div><div class="card"><h4 class="text-lg font-bold text-accent-color mb-3">Usuarios en Tiempo Real</h4><div id="realtime-users" class="space-y-2 max-h-48 overflow-y-auto"></div></div></div></div></div>
    <div id="premium-modal" class="modal-overlay"><div class="modal-container"><button class="modal-close-btn absolute top-2 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button><h3 class="text-3xl font-bold text-center mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">⭐ Desbloquea Plan Pro Premium</h3><p class="text-gray-400 mb-6">Accede a todas las funciones de IA, análisis avanzados y más.</p><div class="card bg-slate-800 border-yellow-500"><p class="text-4xl font-bold text-white">$50,000 COP</p><p class="text-yellow-400">Por 2 Meses de Acceso Total</p></div><button id="pay-premium-btn" class="btn-primary w-full mt-6 text-lg">Pagar y Activar Premium</button><p class="text-xs text-gray-500 mt-4">Serás redirigido a una pasarela de pago segura (simulación).</p></div></div>
    <div id="alert-modal" class="modal-overlay"><div class="modal-container"><p id="alert-modal-message" class="text-white mb-6"></p><div id="alert-modal-buttons" class="flex justify-center gap-4"></div></div></div>
    <div id="ai-modal" class="modal-overlay"><div class="modal-container max-w-2xl"><button class="modal-close-btn absolute top-2 right-4 text-gray-400 hover:text-white text-3xl leading-none">&times;</button><div class="flex justify-between items-center pb-3 border-b border-gray-700"><h3 id="ai-modal-title" class="text-xl font-bold text-white text-left"></h3></div><div id="ai-modal-content-wrapper" class="p-4 overflow-y-auto max-h-[70vh] text-left"><div id="ai-modal-loader" class="hidden justify-center items-center p-12"><div class="loader"></div></div><div id="ai-modal-content"></div></div></div></div>
    <div id="barcode-scanner-modal" class="modal-overlay"><div class="modal-container"><h3 class="text-xl font-bold text-center text-white mb-4">Apunta al código de barras</h3><video id="video-scanner" class="w-full h-auto rounded-lg"></video><button id="close-scanner-btn" class="btn-primary w-full mt-4">Cancelar</button></div></div>

    <!-- MAIN CONTENT -->
    <div id="app-loader" class="fixed inset-0 bg-slate-900 flex flex-col justify-center items-center z-[9999]">
        <div class="loader"></div>
        <p class="text-accent-color mt-4">Cargando Plan Pro...</p>
    </div>

    <div id="app-content" class="min-h-screen pb-16 md:pb-0 hidden">
        <header class="bg-slate-900/50 backdrop-blur-md shadow-lg sticky top-0 z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-pink-500">🔥</span>
                        <h1 class="ml-3 text-xl font-bold tracking-tight">Plan Pro</h1>
                    </div>
                    <div id="auth-controls" class="flex items-center space-x-2">
                         <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <nav class="hidden md:flex justify-center space-x-2 pb-2" id="main-nav">
                <!-- Populated by JS -->
            </nav>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Populated by JS -->
        </main>

        <div class="fixed bottom-0 left-0 right-0 bg-slate-900/80 backdrop-blur-md shadow-[0_-2px_10px_rgba(0,0,0,0.5)] md:hidden h-16">
            <nav class="flex justify-around items-center h-full" id="mobile-nav">
                <!-- Populated by JS -->
            </nav>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, addDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2CH17D7HzmB1eJ6h7KIxNlBx6bF_QrnU",
            authDomain: "plan-pro-daniel.firebaseapp.com",
            databaseURL: "https://plan-pro-daniel-default-rtdb.firebaseio.com",
            projectId: "plan-pro-daniel",
            storageBucket: "plan-pro-daniel.appspot.com",
            messagingSenderId: "1084260343948",
            appId: "1:1084260343948:web:7a799042b781121d5c5897"
        };

        // --- App State and Global Variables ---
        const appState = {
            user: null,
            userData: {},
            isPremium: false,
            listeners: [], // To store unsubscribe functions
        };
        let macroChartInstance;
        let activeWorkoutDay = '1';
        let codeReader;
        const OWNER_UID = "YOUR_OWNER_UID_HERE"; // IMPORTANT: Replace with your Firebase UID after you register
        const PREMIUM_CODE = "DANIELPRO2025";

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.rtdb = getDatabase(app);
                
                setupGlobalEventListeners();
                onAuthStateChanged(window.auth, handleAuthStateChange);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('app-loader').innerHTML = `<p class="text-red-500">Error Crítico: No se pudo conectar a los servicios. Por favor, recarga la página.</p>`;
            }
        });

        async function handleAuthStateChange(user) {
            appState.listeners.forEach(unsubscribe => unsubscribe());
            appState.listeners = [];
            appState.user = user;

            if (user) {
                await setupUserSession(user);
            } else {
                renderLoggedOutUI();
            }
        }

        async function setupUserSession(user) {
            document.getElementById('app-loader').style.display = 'flex';
            const userDocRef = doc(db, "users", user.uid);
            
            const unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    appState.userData = docSnap.data();
                    const premiumUntil = appState.userData.premiumUntil?.toDate();
                    appState.isPremium = appState.userData.isPremium && premiumUntil && premiumUntil > new Date();
                } else {
                    const defaultUserData = {
                        email: user.email, isPremium: false, premiumUntil: null, 
                        macros: { calorias: 2270, proteina: 225, carbs: 200, grasas: 63 },
                    };
                    setDoc(userDocRef, defaultUserData);
                    appState.userData = defaultUserData;
                    appState.isPremium = false;
                }
                renderAppForCurrentUser();
            });
            appState.listeners.push(unsubscribeUser);
            
            ['measurements', 'notes', 'lifts', 'dailyLog'].forEach(name => setupSubCollectionListener(name));
            setupRealtimePresence(user);
        }

        function setupSubCollectionListener(collectionName) {
            if (!appState.user) return;
            const collRef = collection(db, `users/${appState.user.uid}/${collectionName}`);
            const unsubscribe = onSnapshot(collRef, (snapshot) => {
                appState.userData[collectionName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const renderFunction = window[`render${collectionName.charAt(0).toUpperCase() + collectionName.slice(1)}`];
                if (typeof renderFunction === 'function') renderFunction();
            });
            appState.listeners.push(unsubscribe);
        }

        // --- UI Rendering ---
        function renderAppForCurrentUser() {
            buildAuthControls();
            buildNavigation();
            buildContentSections();
            renderAllDataComponents();
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('app-loader').style.display = 'none';
        }

        function renderLoggedOutUI() {
            buildAuthControls();
            document.getElementById('main-nav').innerHTML = '';
            document.getElementById('mobile-nav').innerHTML = '';
            document.getElementById('main-content').innerHTML = `
                <div class="text-center py-20 px-4">
                    <h2 class="text-4xl font-extrabold tracking-tight sm:text-5xl text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-500">Bienvenido a Plan Pro</h2>
                    <p class="mt-4 text-xl text-slate-400">Tu plataforma definitiva de fitness y nutrición.</p>
                    <p class="mt-2 text-slate-500">Inicia sesión o regístrate para comenzar tu transformación.</p>
                </div>
            `;
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('app-loader').style.display = 'none';
        }

        function renderAllDataComponents() {
            updateMacroDisplay();
            renderWorkout(activeWorkoutDay);
            renderMeasurements();
            renderNotes();
            renderLifts();
            renderDailyLog();
            populateExerciseSelects();
            updatePremiumFeatures();
        }

        // --- UI Builders ---
        function buildAuthControls() {
            const authControls = document.getElementById('auth-controls');
            if (appState.user) {
                authControls.innerHTML = `
                    <span class="hidden sm:block text-sm text-gray-400">${appState.user.email}</span>
                    <div id="premium-status-badge" class="ml-2"></div>
                    ${appState.user.uid === OWNER_UID ? '<button id="admin-panel-btn" class="btn-secondary">Admin</button>' : ''}
                    <button id="logout-btn" class="btn-danger">Salir</button>
                `;
            } else {
                authControls.innerHTML = `
                    <button id="login-btn" class="btn-secondary">Iniciar Sesión</button>
                    <button id="register-btn" class="btn-primary">Registrarse</button>
                `;
            }
        }
        
        function buildNavigation() {
            const navItems = [ { id: 'resumen', label: 'Resumen', icon: '📊' }, { id: 'fit-ai', label: 'Fit-AI', icon: '🤖' }, { id: 'nutricion', label: 'Nutrición', icon: '🍎' }, { id: 'entrenamiento', label: 'Entreno', icon: '🏋️' }, { id: 'progreso', label: 'Progreso', icon: '📈' }, { id: 'recursos', label: 'Recursos', icon: '🧠' } ];
            document.getElementById('main-nav').innerHTML = navItems.map(item => `<a href="#" data-tab="${item.id}" class="nav-link px-3 py-2 rounded-md text-sm font-medium">${item.label}</a>`).join('');
            document.getElementById('mobile-nav').innerHTML = navItems.map(item => `<a href="#" data-tab="${item.id}" class="nav-link-mobile flex flex-col items-center text-xs p-1 text-gray-400">${item.icon}<span class="mt-1">${item.label}</span></a>`).join('');
            handleNavigation('resumen');
        }

        function buildContentSections() {
            document.getElementById('main-content').innerHTML = `
                <div class="px-4 py-6 sm:px-0">
                    <section id="resumen" class="content-section active">
                        <div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl text-transparent bg-clip-text bg-gradient-to-r from-white to-pink-400">Tu Panel de Control</h2><p class="mt-4 text-lg text-gray-400">Objetivos nutricionales para máxima definición.</p></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center"><div class="flex flex-col items-center"><div class="chart-container"><canvas id="macroChart"></canvas></div></div><div class="space-y-6"><div class="card text-center"><h3 class="text-lg font-semibold text-gray-500">Calorías Totales</h3><p id="total-calorias" class="text-5xl font-bold text-white">0</p><p class="text-sm text-gray-400">kcal/día</p></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div class="card text-center"><h4 class="text-md font-semibold text-pink-500">Proteínas</h4><p id="gramos-proteina" class="text-3xl font-bold">0g</p></div><div class="card text-center"><h4 class="text-md font-semibold text-blue-400">Carbs</h4><p id="gramos-carbs" class="text-3xl font-bold">0g</p></div><div class="card text-center"><h4 class="text-md font-semibold text-purple-400">Grasas</h4><p id="gramos-grasas" class="text-3xl font-bold">0g</p></div></div><div class="card text-center" data-premium-only><button id="change-goal-ai-btn" class="btn-primary w-full">✨ Ajustar Objetivo con IA</button></div></div></div>
                    </section>
                    <section id="fit-ai" class="content-section">
                         <div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">🤖 Tu Asistente Nutricional</h2><p class="mt-4 text-lg text-gray-400">Usa IA para generar recetas, analizar comidas y planificar tu día.</p></div>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8"><div class="card space-y-4" data-premium-only><h3 class="text-xl font-bold text-center text-pink-500">✨ Buscar Receta</h3><form id="recipe-search-form" class="flex gap-2"><input type="search" id="recipe-search-input" placeholder="Ej: Omelette de espinacas..." class="form-input w-full"><button type="submit" class="btn-primary">🔎</button></form><p class="text-xs text-center text-gray-500">La IA generará una receta y sus macros.</p></div><div class="card space-y-4 flex flex-col justify-center items-center text-center"><h3 class="text-xl font-bold text-pink-500">Escanear Producto</h3><p class="text-sm text-gray-400 flex-grow">Usa tu cámara para obtener la información nutricional de un producto al instante.</p><button id="scan-barcode-btn" class="btn-primary w-full mt-4">📷 Escanear</button></div><div class="card space-y-4" data-premium-only><h3 class="text-xl font-bold text-center text-pink-500">✨ Analizar Comida</h3><input type="file" id="food-image-input" accept="image/*" class="form-input w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-900 file:text-pink-100 hover:file:bg-pink-800"><button id="analyze-image-btn" class="btn-primary w-full">🖼️ Analizar Imagen</button><img id="image-preview" src="" class="hidden w-full max-w-xs mx-auto rounded-lg mt-4"/></div></div>
                         <div class="mt-8" data-premium-only><div class="card text-center"><h3 class="text-xl font-bold text-pink-500">✨ Tu Plan de Comidas Diario</h3><p class="text-sm text-gray-400 my-4">Genera un plan de comidas completo para todo el día que se ajuste perfectamente a tus macros objetivos.</p><form id="meal-plan-form" class="flex flex-col sm:flex-row gap-2 justify-center"><input type="text" id="meal-plan-prefs" class="form-input flex-grow" placeholder="Preferencias (ej: vegetariano, sin lácteos)"><button type="submit" id="generate-meal-plan-btn" class="btn-primary">Generar Plan</button></form></div></div>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8"><div class="card space-y-4"><h3 class="text-xl font-bold text-center">Resultado del Análisis</h3><div id="ai-result-loader" class="hidden justify-center items-center py-8"><div class="loader"></div></div><div id="ai-result-content" class="text-center text-gray-400">Selecciona una herramienta para empezar.</div></div><div class="card space-y-4"><h3 class="text-xl font-bold text-center">Tu Consumo de Hoy</h3><div id="daily-log-progress"></div><div class="flex justify-between items-center"><h4 class="text-lg font-semibold">Comidas Registradas</h4><button id="clear-log-btn" class="btn-danger">Limpiar</button></div><div id="daily-log-history" class="space-y-3 overflow-auto max-h-60 pr-2"></div></div></div>
                    </section>
                    <section id="nutricion" class="content-section">
                        <div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Arquitectura Nutricional</h2><p class="mt-4 text-lg text-gray-400">Usa la matriz para personalizar tus comidas.</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12"><div class="card"><h3 class="text-xl font-bold mb-4">Plan de Alimentación</h3><ul class="space-y-3 text-gray-300"><li><strong class="text-pink-400">Comida 1:</strong> 5 claras + 1 huevo, 1/2 aguacate.</li><li><strong class="text-pink-400">Comida 2:</strong> 200g yogur griego, frutos rojos.</li><li><strong class="text-pink-400">Comida 3 (Pre):</strong> 200g pollo, 200g arroz, brócoli.</li><li><strong class="text-pink-400">Comida 4 (Post):</strong> 40g whey. Luego: 180g lomo, 250g papa.</li><li><strong class="text-pink-400">Comida 5:</strong> 200g cottage o 180g salmón, almendras.</li></ul></div><div class="card"><h3 class="text-xl font-bold mb-4">Estrategia y Flexibilidad</h3><div class="space-y-4 text-gray-300"><p><strong class="text-pink-400">Frecuencia:</strong> 4-6 comidas para optimizar MPS.</p><p><strong class="text-pink-400">Timing de Carbs:</strong> Concentra carbs pre/post entreno.</p><p><strong class="text-pink-400">Consistencia:</strong> Es la clave, mantén calorías y proteína estables.</p><p><strong class="text-pink-400">Hidratación:</strong> Mínimo 3-4 litros de agua/día.</p></div></div></div>
                        <div class="card"><h3 class="text-xl font-bold mb-4 text-center">Matriz de Selección de Alimentos</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-400"><thead class="text-xs text-gray-300 uppercase bg-slate-900/30"><tr><th class="px-6 py-3">Proteína</th><th class="px-6 py-3">Carbs</th><th class="px-6 py-3">Grasas</th><th class="px-6 py-3">Verduras/Frutas</th></tr></thead><tbody class="divide-y divide-slate-800"><tr><td class="px-6 py-4">Pechuga de pollo/pavo</td><td class="px-6 py-4">Avena, arroz</td><td class="px-6 py-4">Aguacate</td><td class="px-6 py-4">Brócoli, espinaca</td></tr><tr><td class="px-6 py-4">Lomo de res/cerdo</td><td class="px-6 py-4">Papa, batata, yuca</td><td class="px-6 py-4">Aceite de oliva</td><td class="px-6 py-4">Coliflor, pimentón</td></tr><tr><td class="px-6 py-4">Pescado blanco</td><td class="px-6 py-4">Plátano, pasta</td><td class="px-6 py-4">Nueces, almendras</td><td class="px-6 py-4">Cebolla, tomate</td></tr></tbody></table></div></div>
                    </section>
                    <section id="entrenamiento" class="content-section">
                        <div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Protocolo de Entrenamiento</h2><p class="mt-4 text-lg text-gray-400">Enfoque en técnica, RIR y sobrecarga progresiva.</p><div class="mt-6" data-premium-only><button id="modify-workout-ai-btn" class="btn-primary text-lg py-3 px-6">🦾 Modificar Rutina con IA</button></div></div>
                        <div class="flex justify-center flex-wrap gap-2 mb-8" id="workout-nav"><button data-day="1" class="workout-day-btn active px-4 py-2 text-sm font-bold rounded-md">Día 1</button><button data-day="2" class="workout-day-btn px-4 py-2 text-sm font-bold rounded-md">Día 2</button><button data-day="3" class="workout-day-btn px-4 py-2 text-sm font-bold rounded-md">Día 3</button><button data-day="4" class="workout-day-btn px-4 py-2 text-sm font-bold rounded-md">Día 4</button><button data-day="5" class="workout-day-btn px-4 py-2 text-sm font-bold rounded-md">Día 5</button></div>
                        <div id="workout-content" class="card"></div>
                    </section>
                    <section id="progreso" class="content-section">
                        <div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Tu Centro de Progreso</h2><p class="mt-4 text-lg text-gray-400">Registra tus métricas, notas y levantamientos. La data es poder.</p><div class="mt-6" data-premium-only><button id="analyze-progress-btn" class="btn-primary text-lg py-3 px-6">✨ ¡Analiza Mi Progreso con IA!</button></div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="card space-y-4"><h3 class="text-xl font-bold text-center text-pink-500">Registro de Medidas</h3><form id="measurement-form" class="grid grid-cols-2 gap-4"><input type="date" id="measure-date" class="form-input col-span-2"><input type="number" step="0.1" id="measure-weight" placeholder="Peso (kg)" class="form-input"><input type="number" step="0.1" id="measure-waist" placeholder="Cintura (cm)" class="form-input"><input type="number" step="0.1" id="measure-chest" placeholder="Pecho (cm)" class="form-input"><input type="number" step="0.1" id="measure-arm" placeholder="Brazo (cm)" class="form-input"><button type="submit" class="btn-primary col-span-2">Guardar Medidas</button></form><div class="overflow-auto max-h-60"><table class="w-full text-sm text-left"><thead class="text-xs text-pink-400 uppercase bg-slate-900/30"><tr><th class="p-2">Fecha</th><th class="p-2">Peso</th><th class="p-2">Cintura</th><th class="p-2">Pecho</th><th class="p-2">Brazo</th><th class="p-2"></th></tr></thead><tbody id="measurements-history" class="divide-y divide-slate-800"></tbody></table></div></div><div class="card space-y-4"><h3 class="text-xl font-bold text-center text-pink-500">Bitácora de Notas</h3><form id="notes-form" class="space-y-4"><textarea id="note-text" rows="4" class="form-textarea" placeholder="Anota tus victorias, sensaciones, ajustes..."></textarea><div class="grid grid-cols-2 gap-2"><button type="submit" class="btn-primary w-full">Guardar Nota</button><button type="button" id="analyze-wellness-btn" class="btn-primary w-full" data-premium-only>✨ Analizar Bienestar</button></div></form><div id="notes-history" class="space-y-3 overflow-auto max-h-60 pr-2"></div></div><div class="card lg:col-span-2 space-y-4"><h3 class="text-xl font-bold text-center text-pink-500">Registro de Levantamientos</h3><form id="lift-form" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end"><div class="sm:col-span-2"><label for="lift-exercise" class="text-xs text-gray-400">Ejercicio</label><select id="lift-exercise" class="form-select w-full"></select></div><div><label for="lift-weight" class="text-xs text-gray-400">Peso (kg)</label><input type="number" step="0.5" id="lift-weight" placeholder="kg" class="form-input w-full"></div><div><label for="lift-reps" class="text-xs text-gray-400">Reps</label><input type="number" id="lift-reps" placeholder="Reps" class="form-input w-full"></div><button type="submit" class="btn-primary sm:col-span-4 w-full">Guardar Levantamiento</button></form><div class="flex justify-between items-center"><h4 class="text-lg font-semibold">Historial</h4><select id="lift-filter" class="form-select w-1/2 sm:w-1/3"></select></div><div class="overflow-auto max-h-72"><table class="w-full text-sm text-left"><thead class="text-xs text-pink-400 uppercase bg-slate-900/30"><tr><th class="p-2">Fecha</th><th class="p-2">Ejercicio</th><th class="p-2">Peso</th><th class="p-2">Reps</th><th class="p-2"></th></tr></thead><tbody id="lifts-history" class="divide-y divide-slate-800"></tbody></table></div></div></div>
                    </section>
                    <section id="recursos" class="content-section">
                        <div class="text-center mb-10"><h2 class="text-3xl font-bold tracking-tight sm:text-4xl">Caja de Herramientas</h2><p class="mt-4 text-lg text-gray-400">Conocimiento clave para potenciar tus resultados.</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><div class="card md:col-span-2"><h3 class="text-2xl font-bold mb-4">Calculadoras de Entrenamiento</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h4 class="font-bold text-lg text-pink-500 mb-2">Calculadora de 1RM Estimado</h4><form id="1rm-form" class="space-y-3"><input type="number" id="1rm-weight" placeholder="Peso levantado (kg)" class="form-input w-full"><input type="number" id="1rm-reps" placeholder="Repeticiones completadas" class="form-input w-full"><button type="submit" class="btn-primary w-full">Calcular 1RM</button></form><p id="1rm-result" class="mt-3 font-bold text-center text-xl"></p></div><div><h4 class="font-bold text-lg text-pink-500 mb-2">Calculadora de Peso por RIR</h4><form id="rir-form" class="space-y-3"><input type="number" id="rir-1rm" placeholder="Tu 1RM estimado (kg)" class="form-input w-full"><input type="number" id="rir-reps" placeholder="Repeticiones objetivo" class="form-input w-full"><input type="number" id="rir-rir" placeholder="RIR deseado (0-3)" class="form-input w-full"><button type="submit" class="btn-primary w-full">Calcular Peso</button></form><p id="rir-result" class="mt-3 font-bold text-center text-xl"></p></div></div></div><div class="card lg:row-start-1 lg:col-start-3" data-premium-only><h3 class="text-2xl font-bold mb-4">✨ Stack de Suplementos</h3><form id="supplement-form" class="space-y-3"><p class="text-sm text-gray-400">Describe tu objetivo principal (ej. ganar músculo, perder grasa) para recibir una sugerencia.</p><input type="text" id="supplement-goal" placeholder="Mi objetivo es..." class="form-input w-full"><button type="submit" class="btn-primary w-full">Generar Sugerencia</button></form></div><div class="card"><h3 class="text-2xl font-bold mb-4">Fundamentales</h3><ul class="text-sm list-disc list-inside text-gray-300 space-y-2"><li><strong>Abdomen:</strong> Sobrecarga progresiva con Crunch en Polea y Elev. de Piernas Colgado.</li><li><strong>Antebrazo:</strong> Atacar con flexión/extensión de muñeca y trabajo de agarre.</li></ul></div><div class="card"><h3 class="text-2xl font-bold mb-4">Ciencia</h3><ul class="text-sm list-disc list-inside text-gray-300 space-y-2"><li><strong>Déficit Calórico:</strong> Esencial para la oxidación de grasa.</li><li><strong>Proteína Elevada:</strong> Clave para la retención muscular.</li><li><strong>Sobrecarga Progresiva:</strong> El pilar del progreso.</li></ul></div><div class="card"><h3 class="text-2xl font-bold mb-4">Mindset</h3><ul class="text-sm list-disc list-inside text-gray-300 space-y-2"><li><strong>Consistencia > Perfección.</strong></li><li><strong>Paciencia y objetividad.</strong></li><li><strong>Conexión Mente-Músculo.</strong></li></ul></div></div>
                    </section>
                </div>
            `;
        }
        
        // --- Event Handling ---
        function setupGlobalEventListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                // Auth buttons
                if (target.id === 'login-btn') showAuthForm('login');
                if (target.id === 'register-btn') showAuthForm('register');
                if (target.id === 'logout-btn') signOut(auth);
                if (target.id === 'auth-switch') showAuthForm(target.dataset.type);
                // Modals
                if (target.closest('.modal-close-btn')) target.closest('.modal-overlay').style.display = 'none';
                if (target.id === 'admin-panel-btn') { document.getElementById('admin-modal').style.display = 'flex'; setupAdminPanel(); }
                if (target.id === 'pay-premium-btn') handlePremiumPayment();
                if (target.closest('.locked')) document.getElementById('premium-modal').style.display = 'flex';
                // Navigation
                const navLink = target.closest('.nav-link, .nav-link-mobile');
                if (navLink) { e.preventDefault(); handleNavigation(navLink.dataset.tab); }
                // Workout Day Navigation
                const workoutBtn = target.closest('.workout-day-btn');
                if (workoutBtn) handleWorkoutNav(workoutBtn);
                // Dynamic content buttons
                if (target.classList.contains('delete-btn')) handleDeleteItem(target);
                const aiActionBtn = target.closest('.ai-action-btn');
                if (aiActionBtn) handleWorkoutAIAction(aiActionBtn);
                // Specific buttons
                if (target.id === 'scan-barcode-btn') startScanner();
                if (target.id === 'close-scanner-btn') stopScanner();
                if (target.id === 'clear-log-btn') handleClearLog();
                if (target.id === 'analyze-image-btn') handleAnalyzeImage();
                if (target.id === 'change-goal-ai-btn') handleChangeGoalAI();
                if (target.id === 'modify-workout-ai-btn') handleModifyWorkout();
                if (target.id === 'analyze-progress-btn') handleAnalyzeProgress();
                if (target.id === 'analyze-wellness-btn') handleAnalyzeWellness();
            });

            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const handler = window.formHandlers[form.id];
                if (handler) handler(form);
            });
            
            document.body.addEventListener('change', (e) => {
                if(e.target.id === 'lift-filter') renderLifts();
                if(e.target.id === 'food-image-input') handleImagePreview(e.target);
            });
        }
        
        function handleNavigation(tabId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(l => {
                l.classList.remove('active');
                if (l.dataset.tab === tabId) l.classList.add('active');
            });
            window.scrollTo(0, 0);
        }

        // --- Feature Logic & Handlers ---
        function showAuthForm(type) {
            const isLogin = type === 'login';
            document.getElementById('auth-modal-content').innerHTML = `
                <h3 class="text-2xl font-bold text-center text-white mb-6">${isLogin ? 'Iniciar Sesión' : 'Crear Cuenta'}</h3>
                <form id="auth-form" data-type="${type}" class="space-y-4">
                    <input type="email" name="email" class="form-input" placeholder="Correo electrónico" required>
                    <input type="password" name="password" class="form-input" placeholder="Contraseña (mín. 6 caracteres)" required>
                    <p class="auth-error text-red-500 text-sm hidden"></p>
                    <button type="submit" class="btn-primary w-full">${isLogin ? 'Entrar' : 'Registrarse'}</button>
                </form>
                <p class="text-sm text-gray-400 mt-4">
                    ${isLogin ? '¿No tienes cuenta?' : '¿Ya tienes cuenta?'}
                    <button id="auth-switch" data-type="${isLogin ? 'register' : 'login'}" class="font-semibold text-accent-color hover:underline">${isLogin ? 'Regístrate' : 'Inicia Sesión'}</button>
                </p>
            `;
            document.getElementById('auth-modal').style.display = 'flex';
        }

        async function handleAuthForm(form) {
            const type = form.dataset.type;
            const email = form.elements.email.value;
            const password = form.elements.password.value;
            const errorEl = form.querySelector('.auth-error');
            errorEl.classList.add('hidden');

            try {
                if (type === 'login') {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                document.getElementById('auth-modal').style.display = 'none';
            } catch (error) {
                errorEl.textContent = getFirebaseErrorMessage(error);
                errorEl.classList.remove('hidden');
            }
        }
        
        function getFirebaseErrorMessage(error) {
            console.error("Firebase Auth Error:", error);
            switch (error.code) {
                case 'auth/invalid-email': return 'El formato del correo es inválido.';
                case 'auth/user-not-found':
                case 'auth/wrong-password': return 'Correo o contraseña incorrectos.';
                case 'auth/email-already-in-use': return 'Este correo ya está registrado.';
                case 'auth/weak-password': return 'La contraseña debe tener al menos 6 caracteres.';
                default: return `Ocurrió un error: ${error.message}`;
            }
        }

        // --- Data Rendering Functions ---
        function updatePremiumFeatures() {
            const premiumBadge = document.getElementById('premium-status-badge');
            if (premiumBadge) {
                premiumBadge.innerHTML = appState.isPremium ? `<span class="premium-badge">⭐ Premium</span>` : '';
            }
            document.querySelectorAll('[data-premium-only]').forEach(el => {
                el.classList.toggle('locked', !appState.isPremium);
            });
        }

        function updateMacroDisplay() {
            if (!document.getElementById('total-calorias')) return;
            const macros = appState.userData.macros || { calorias: 0, proteina: 0, carbs: 0, grasas: 0 };
            document.getElementById('total-calorias').textContent = Math.round(macros.calorias);
            document.getElementById('gramos-proteina').textContent = `${Math.round(macros.proteina)}g`;
            document.getElementById('gramos-carbs').textContent = `${Math.round(macros.carbs)}g`;
            document.getElementById('gramos-grasas').textContent = `${Math.round(macros.grasas)}g`;
            renderMacroChart(macros);
        }

        window.renderMeasurements = function() {
            const el = document.getElementById('measurements-history');
            if (!el) return;
            const measurements = appState.userData.measurements || [];
            measurements.sort((a,b) => b.date.toDate() - a.date.toDate());
            el.innerHTML = measurements.map(m => `<tr><td class="p-2">${m.date.toDate().toLocaleDateString('es-CO',{timeZone:'UTC'})}</td><td class="p-2">${m.weight||'N/A'} kg</td><td class="p-2">${m.waist||'N/A'} cm</td><td class="p-2">${m.chest||'N/A'} cm</td><td class="p-2">${m.arm||'N/A'} cm</td><td class="p-2 text-right"><button class="btn-danger delete-btn" data-type="measurements" data-id="${m.id}">X</button></td></tr>`).join('');
        }
        
        window.renderNotes = function() {
            const el = document.getElementById('notes-history');
            if (!el) return;
            const notes = appState.userData.notes || [];
            notes.sort((a,b) => b.date.toDate() - a.date.toDate());
            el.innerHTML = notes.map(n => `<div class="bg-slate-900/20 p-3 rounded-lg"><p class="text-sm text-gray-300 whitespace-pre-wrap">${n.text}</p><div class="text-xs text-gray-500 mt-2 flex justify-between items-center">${n.date.toDate().toLocaleString('es-CO')} <button class="btn-danger delete-btn" data-type="notes" data-id="${n.id}">X</button></div></div>`).join('');
        }

        window.renderLifts = function() {
            const el = document.getElementById('lifts-history');
            if (!el) return;
            const lifts = appState.userData.lifts || [];
            lifts.sort((a, b) => b.date.toDate() - a.date.toDate());
            const filter = document.getElementById('lift-filter')?.value || 'all';
            const filteredLifts = filter === 'all' ? lifts : lifts.filter(l => l.exercise === filter);
            el.innerHTML = filteredLifts.map(l => `<tr><td class="p-2">${l.date.toDate().toLocaleDateString('es-CO', {timeZone:'UTC'})}</td><td class="p-2 font-semibold">${l.exercise}</td><td class="p-2">${l.weight} kg</td><td class="p-2">${l.reps}</td><td class="p-2 text-right"><button class="btn-danger delete-btn" data-type="lifts" data-id="${l.id}">X</button></td></tr>`).join('');
        }

        window.renderDailyLog = function() {
            const historyEl = document.getElementById('daily-log-history');
            const progressEl = document.getElementById('daily-log-progress');
            if (!historyEl || !progressEl) return;
            const dailyLog = appState.userData.dailyLog || [];
            const today = new Date().toISOString().split('T')[0];
            const todaysMeals = dailyLog.filter(m => m.date.toDate().toISOString().split('T')[0] === today);
            const totals = todaysMeals.reduce((acc, meal) => ({ calories: acc.calories + meal.calories, protein: acc.protein + meal.protein, carbs: acc.carbs + meal.carbs, fat: acc.fat + meal.fat }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
            historyEl.innerHTML = todaysMeals.map(m => `<div class="bg-slate-900/20 p-3 rounded-lg text-sm"><div class="flex justify-between items-start"><p class="font-semibold text-white flex-1 pr-2">${m.name}</p><button class="btn-danger delete-btn" data-type="dailyLog" data-id="${m.id}">X</button></div><p class="text-gray-400 mt-1">${m.calories}kcal | P:${m.protein}g C:${m.carbs}g G:${m.fat}g</p></div>`).join('') || '<p class="text-center text-gray-500">No hay comidas registradas hoy.</p>';
            const targets = appState.userData.macros || {};
            const progressData = [ { label: 'Calorías', current: totals.calories, target: targets.calorias, color: 'bg-yellow-500' }, { label: 'Proteína', current: totals.protein, target: targets.proteina, color: 'bg-pink-500' }, { label: 'Carbs', current: totals.carbs, target: targets.carbs, color: 'bg-blue-500' }, { label: 'Grasas', current: totals.fat, target: targets.grasas, color: 'bg-purple-500' }, ];
            progressEl.innerHTML = progressData.map(p => { const percentage = p.target > 0 ? Math.min((p.current / p.target) * 100, 100) : 0; return `<div class="mb-3"><div class="flex justify-between items-baseline mb-1 text-sm"><span class="font-bold">${p.label}</span><span class="text-gray-400">${Math.round(p.current)} / ${p.target || 0} ${p.label === 'Calorías' ? 'kcal' : 'g'}</span></div><div class="progress-bar-bg h-2.5 w-full bg-slate-700 rounded-full"><div class="h-full rounded-full ${p.color}" style="width: ${percentage}%"></div></div></div>`; }).join('');
        }

        // --- Form Handlers ---
        window.formHandlers = {
            'auth-form': handleAuthForm,
            'premium-code-form': async (form) => { /* ... */ },
            'measurement-form': async (form) => {
                if(!form.elements['measure-date'].value) { showAlert('Selecciona una fecha.'); return;}
                const data = { date: Timestamp.fromDate(new Date(form.elements['measure-date'].value)), weight: form.elements['measure-weight'].value || null, waist: form.elements['measure-waist'].value || null, chest: form.elements['measure-chest'].value || null, arm: form.elements['measure-arm'].value || null };
                await addDoc(collection(db, `users/${appState.user.uid}/measurements`), data);
                form.reset();
                showAlert('Medidas guardadas.');
            },
            'notes-form': async (form) => {
                const text = form.elements['note-text'].value.trim();
                if (!text) return;
                await addDoc(collection(db, `users/${appState.user.uid}/notes`), { date: Timestamp.now(), text });
                form.reset();
                showAlert('Nota guardada.');
            },
            // ... add all other form handlers here
        };
        
        // --- All other functions (API calls, specific handlers, etc.) would go here ---
        // These can be simplified as they are called directly from the main event listener
        function showAlert(message) {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal-buttons').innerHTML = `<button class="btn-primary">OK</button>`;
            modal.style.display = 'flex';
            modal.querySelector('button').onclick = () => modal.style.display = 'none';
        }

        function showConfirm(message, onConfirm) {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-modal-message').textContent = message;
            document.getElementById('alert-modal-buttons').innerHTML = `<button class="btn-secondary">Cancelar</button><button class="btn-danger">Confirmar</button>`;
            modal.style.display = 'flex';
            modal.querySelector('.btn-danger').onclick = () => { modal.style.display = 'none'; onConfirm(); };
            modal.querySelector('.btn-secondary').onclick = () => modal.style.display = 'none';
        }
        
        // Placeholder for other functions to avoid reference errors
        function renderMacroChart(macros) { /* ... */ }
        function renderWorkout(day) { /* ... */ }
        function populateExerciseSelects() { /* ... */ }
        function handleWorkoutNav(btn) { /* ... */ }
        function handleDeleteItem(btn) { /* ... */ }
        function handleWorkoutAIAction(btn) { /* ... */ }
        function startScanner() { /* ... */ }
        function stopScanner() { /* ... */ }
        function handleClearLog() { /* ... */ }
        function handleAnalyzeImage() { /* ... */ }
        function handleChangeGoalAI() { /* ... */ }
        function handleModifyWorkout() { /* ... */ }
        function handleAnalyzeProgress() { /* ... */ }
        function handleAnalyzeWellness() { /* ... */ }
        function handleImagePreview(input) { /* ... */ }
        function setupAdminPanel() { /* ... */ }
        function handlePremiumPayment() { /* ... */ }
        function setupRealtimePresence(user) { /* ... */ }

    </script>
</body>
</html>
